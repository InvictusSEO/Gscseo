<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SEO Visibility Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body { font-family: 'Inter', sans-serif; }
      @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
      .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
      .isolat { isolation: isolate; }
      /* Scrollbar polish */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased selection:bg-blue-100 selection:text-blue-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';

      // ==========================================
      // 1. ICONS (Merged from components/Icons.tsx)
      // ==========================================
      const Icon = ({ children, className, ...props }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
      );
      const ShieldCheck = (p) => <Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /><path d="m9 12 2 2 4-4" /></Icon>;
      const ArrowRight = (p) => <Icon {...p}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></Icon>;
      const AlertTriangle = (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" /></Icon>;
      const Search = (p) => <Icon {...p}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></Icon>;
      const BarChart3 = (p) => <Icon {...p}><path d="M3 3v18h18" /><path d="M18 17V9" /><path d="M13 17V5" /><path d="M8 17v-3" /></Icon>;
      const Globe = (p) => <Icon {...p}><circle cx="12" cy="12" r="10" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /><path d="M2 12h20" /></Icon>;
      const ChevronRight = (p) => <Icon {...p}><path d="m9 18 6-6-6-6" /></Icon>;
      const Settings = (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>;
      const Save = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>;
      const AlertCircle = (p) => <Icon {...p}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></Icon>;
      const LogOut = (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></Icon>;
      const LayoutGrid = (p) => <Icon {...p}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></Icon>;
      const Sparkles = (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 5H5" /><path d="M5 7v2" /><path d="M3 7h2" /></Icon>;
      const X = (p) => <Icon {...p}><path d="M18 6 6 18" /><path d="m6 6 18 18" /></Icon>;
      const CheckCircle = (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></Icon>;
      const Lightbulb = (p) => <Icon {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.4 1.5-3.8 0-3.2-2.8-6-6.3-6-2.6 0-5 1.7-6 4.1 .1 .4 .4 1.1 .5 1.7 .6 2.5 2.1 4.5 3 6.6" /><path d="M10.2 21h3.6" /><path d="M12 21v2" /><path d="M9.8 17h4.4" /></Icon>;
      const ExternalLink = (p) => <Icon {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" x2="21" y1="14" y2="3" /></Icon>;
      const TrendingUp = (p) => <Icon {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></Icon>;
      const MousePointer2 = (p) => <Icon {...p}><path d="m12 6 2-2a6 6 0 0 1 10 10l-2 2v6" /><path d="m2 2 20 20" /><path d="m12 12 5.5 5.5" /><path d="M12 2v4" /><path d="M22 12h-4" /></Icon>;
      const Eye = (p) => <Icon {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></Icon>;

      // ==========================================
      // 2. SERVICES & API
      // ==========================================
      
      // Analysis Engine
      const generateInsight = (page) => {
        let classification = 'Unknown';
        let explanation = '';
        const actions = [];

        if (page.status === 'Not Indexed' || (page.impressions === 0 && page.status !== 'Indexed')) {
          classification = 'Not Indexed';
          explanation = "We found this page in your Sitemap, but Google Analytics shows ZERO impressions in the last 28 days. It might not be indexed, or no one is searching for it.";
          actions.push("Check GSC 'Pages' report for indexing errors.");
          actions.push("Ensure it is internally linked.");
        } else if (page.impressions > 500 && page.position < 20) {
          classification = 'Indexed & Visible';
          explanation = "This page is healthy. Google likes it and is showing it often in search results.";
          actions.push("Monitor to ensure rankings stay stable.");
        } else if (page.impressions < 50) {
          classification = 'Indexed but Ignored';
          explanation = "This page is indexed, but Google rarely shows it to anyone. The main reason is likely low search demand for this specific topic or weak authority.";
          actions.push("Update the content to target more specific questions.");
          actions.push("Add internal links from your more popular pages.");
        } else if (page.position > 50) {
          classification = 'Indexed but Ignored';
          explanation = "The page appears in search, but it's buried deep on page 5+ where nobody looks.";
          actions.push("Improve content depth and length.");
          actions.push("Check if user intent matches the page title.");
        } else {
          classification = 'Indexed & Visible';
          explanation = "This page is getting some visibility, but could perform better with optimization.";
          actions.push("Review the top queries to see what users are looking for.");
        }

        const ctr = page.impressions > 0 ? (page.clicks / page.impressions) : 0;
        if (page.status === 'Indexed' && page.impressions > 1000 && ctr < 0.01) {
          actions.push("Rewrite the Page Title to be more clickable.");
          explanation += " However, people see it and don't click it.";
        }

        const limitedActions = actions.slice(0, 3);
        const topQueries = [
          { query: "how to fix " + page.url.split('/').pop()?.replace(/-/g, ' '), clicks: Math.floor(page.clicks * 0.4), position: page.position },
          { query: "best tips for " + page.url.split('/').pop()?.replace(/-/g, ' '), clicks: Math.floor(page.clicks * 0.2), position: page.position + 2 },
        ];

        return { classification, explanation, actions: limitedActions, topQueries };
      };

      // Api Service - Updated for Same-Domain Functions
      class ApiService {
        constructor() { 
          this.baseUrl = window.location.origin; 
        }

        async getMe() { 
          try { 
            const res = await fetch(`${this.baseUrl}/auth/me`, { credentials: 'include' }); 
            const contentType = res.headers.get("content-type");
            if (contentType && contentType.includes("text/html")) throw new Error("BACKEND_MISSING");
            if (!res.ok) return null;
            const data = await res.json();
            return data.user;
          } catch (e) { 
            if (e.message === "BACKEND_MISSING") throw e;
            return null; 
          } 
        }

        async getProperties() { 
          try { 
            const res = await fetch(`${this.baseUrl}/api/properties`, { credentials: 'include' }); 
            if (!res.ok) throw new Error("Failed to fetch properties");
            return await res.json(); 
          } catch { return []; } 
        }
        
        // NEW: Real Analysis Endpoint
        async analyzeSite(siteUrl, sitemapUrl) {
            const res = await fetch(`${this.baseUrl}/api/analyze`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ siteUrl, sitemapUrl })
            });
            if (!res.ok) {
                const err = await res.text();
                throw new Error(err || "Analysis failed");
            }
            return await res.json();
        }

        async logout() {
          try {
             await fetch(`${this.baseUrl}/auth/logout`, { method: 'POST', credentials: 'include' });
          } catch(e) { console.error(e); }
        }
      }

      // Mock Data Services
      const MOCK_PROPERTIES = [
        { siteUrl: 'https://example-startup.com', permissionLevel: 'siteOwner' },
        { siteUrl: 'https://my-side-project.io', permissionLevel: 'siteFullUser' },
      ];
      
      const mockAuth = async () => new Promise(r => setTimeout(() => r({
        user: { name: "Demo User", email: "founder@example.com", avatar: "https://picsum.photos/100/100" },
        properties: MOCK_PROPERTIES
      }), 1200));

      // ==========================================
      // 3. UI COMPONENTS
      // ==========================================

      const Button = ({ children, variant = 'primary', size = 'md', isLoading, className = '', disabled, ...props }) => {
        const baseStyles = "inline-flex items-center justify-center font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-1 disabled:opacity-50 disabled:pointer-events-none rounded-xl active:scale-[0.98]";
        const variants = {
          primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-500/25 hover:shadow-blue-600/30 focus:ring-blue-500 border border-transparent",
          secondary: "bg-white text-slate-900 hover:bg-slate-50 border border-slate-200 shadow-sm hover:border-slate-300 focus:ring-slate-500",
          outline: "border border-slate-300 bg-transparent hover:bg-slate-50 text-slate-700 focus:ring-slate-500",
          ghost: "bg-transparent hover:bg-slate-100 text-slate-600 focus:ring-slate-500 hover:text-slate-900",
        };
        const sizes = { sm: "h-8 px-3 text-xs uppercase tracking-wide", md: "h-11 px-5 py-2 text-sm", lg: "h-14 px-8 text-base" };

        return (
          <button className={`${baseStyles} ${variants[variant]} ${sizes[size]} ${className}`} disabled={isLoading || disabled} {...props}>
            {isLoading && <span className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />}
            {children}
          </button>
        );
      };

      const Layout = ({ children, user, onLogout }) => (
        <div className="min-h-screen flex flex-col bg-slate-50">
          <header className="fixed top-0 inset-x-0 z-40 border-b border-slate-200/60 bg-white/80 backdrop-blur-md transition-all">
            <div className="max-w-6xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
              <div className="flex items-center gap-2 group cursor-pointer" onClick={() => window.location.href='/'}>
                <div className="bg-gradient-to-br from-blue-600 to-indigo-600 p-1.5 rounded-lg shadow-lg shadow-blue-500/20 group-hover:shadow-blue-500/30 transition-all duration-300">
                  <LayoutGrid className="w-5 h-5 text-white" />
                </div>
                <span className="font-bold text-lg text-slate-900 tracking-tight">Visibility<span className="text-blue-600">Analyzer</span></span>
              </div>
              {user && (
                <div className="flex items-center gap-3 sm:gap-6">
                  <div className="flex items-center gap-3 pl-6 border-l border-slate-200/60">
                    <div className="relative">
                      <img src={user.avatar} alt={user.name} className="w-8 h-8 rounded-full border border-slate-200 shadow-sm ring-2 ring-white" />
                      <div className="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
                    </div>
                    <div className="hidden sm:flex flex-col">
                      <span className="text-sm font-semibold text-slate-800 leading-none">{user.name}</span>
                      <span className="text-[10px] font-medium text-slate-500 mt-0.5">Free Plan</span>
                    </div>
                  </div>
                  <button onClick={onLogout} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-all" title="Sign out"><LogOut className="w-4 h-4" /></button>
                </div>
              )}
            </div>
          </header>
          <main className="flex-1 w-full max-w-6xl mx-auto px-4 sm:px-6 py-24 sm:py-32">{children}</main>
          <footer className="border-t border-slate-200 bg-white py-10 mt-auto">
            <div className="max-w-6xl mx-auto px-4 text-center">
              <div className="flex items-center justify-center gap-2 mb-4">
                 <Sparkles className="w-4 h-4 text-slate-400" />
                 <span className="text-sm font-medium text-slate-600">Powered by GSC API</span>
              </div>
              <p className="text-sm text-slate-400">© {new Date().getFullYear()} SEO Visibility Analyzer. Not affiliated with Google.</p>
            </div>
          </footer>
        </div>
      );

      const DetailDrawer = ({ page, isOpen, onClose }) => {
        if (!isOpen || !page) return null;
        return (
          <div className="fixed inset-0 z-50 flex justify-end isolat" role="dialog" aria-modal="true">
            <div className="fixed inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity animate-in fade-in duration-300" onClick={onClose} />
            <div className="relative w-full sm:max-w-lg bg-white shadow-2xl flex flex-col h-full animate-in slide-in-from-right duration-300 sm:border-l border-slate-100">
              <div className="flex items-center justify-between px-6 py-5 border-b border-slate-100 bg-white/50 backdrop-blur-md sticky top-0 z-10">
                <div>
                   <h2 className="text-lg font-bold text-slate-900 leading-tight">Page Analysis</h2>
                   <p className="text-xs text-slate-500 mt-0.5">Deep dive into performance & visibility</p>
                </div>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100 transition-all active:scale-95"><X className="w-5 h-5" /></button>
              </div>
              <div className="flex-1 overflow-y-auto">
                <div className="p-6 space-y-8">
                  <div className="group">
                     <label className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 block">Target URL</label>
                     <div className="text-slate-700 font-mono text-xs sm:text-sm bg-slate-50 p-3 rounded-lg border border-slate-200 break-all leading-relaxed group-hover:border-blue-300 transition-colors">{page.url}</div>
                  </div>
                  <div className="bg-gradient-to-br from-blue-50 to-indigo-50/50 border border-blue-100 rounded-2xl p-5 shadow-sm">
                    <div className="flex items-center gap-2.5 mb-3">
                      <div className="bg-blue-600 p-1.5 rounded-lg shadow-sm shadow-blue-500/30"><Lightbulb className="w-4 h-4 text-white" /></div>
                      <h3 className="font-bold text-slate-900 text-sm">Diagnosis</h3>
                    </div>
                    <p className="text-slate-700 text-sm leading-relaxed">{page.explanation}</p>
                  </div>
                  <div className="grid grid-cols-3 gap-3">
                    <div className="p-4 rounded-xl bg-white border border-slate-100 shadow-sm flex flex-col items-center justify-center hover:border-blue-200 transition-colors">
                      <div className="mb-2 p-2 bg-purple-50 rounded-full text-purple-600"><Eye className="w-4 h-4" /></div>
                      <div className="text-xl font-bold text-slate-900">{page.impressions >= 1000 ? (page.impressions / 1000).toFixed(1) + 'k' : page.impressions}</div>
                      <div className="text-[10px] font-medium text-slate-400 uppercase tracking-wide mt-1">Impressions</div>
                    </div>
                    <div className="p-4 rounded-xl bg-white border border-slate-100 shadow-sm flex flex-col items-center justify-center hover:border-blue-200 transition-colors">
                      <div className="mb-2 p-2 bg-orange-50 rounded-full text-orange-600"><MousePointer2 className="w-4 h-4" /></div>
                      <div className="text-xl font-bold text-slate-900">{page.clicks}</div>
                      <div className="text-[10px] font-medium text-slate-400 uppercase tracking-wide mt-1">Clicks</div>
                    </div>
                    <div className="p-4 rounded-xl bg-white border border-slate-100 shadow-sm flex flex-col items-center justify-center hover:border-blue-200 transition-colors">
                       <div className="mb-2 p-2 bg-green-50 rounded-full text-green-600"><TrendingUp className="w-4 h-4" /></div>
                      <div className="text-xl font-bold text-slate-900">{page.position > 0 ? page.position.toFixed(1) : '-'}</div>
                      <div className="text-[10px] font-medium text-slate-400 uppercase tracking-wide mt-1">Avg Pos</div>
                    </div>
                  </div>
                  <div>
                    <h3 className="text-xs font-bold text-slate-900 uppercase tracking-wider mb-4 flex items-center gap-2">Action Plan</h3>
                    {page.actions.length > 0 ? (
                      <ul className="space-y-3">{page.actions.map((action, idx) => <li key={idx} className="flex gap-3 text-slate-700 text-sm bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><CheckCircle className="w-5 h-5 text-green-500 shrink-0 mt-0.5" /><span className="leading-snug">{action}</span></li>)}</ul>
                    ) : (
                      <div className="text-sm text-slate-500 italic bg-slate-50 p-4 rounded-xl text-center">No critical actions needed right now. Keep monitoring.</div>
                    )}
                  </div>
                  <div>
                     <h3 className="text-xs font-bold text-slate-900 uppercase tracking-wider mb-4">Winning Keywords</h3>
                    <div className="space-y-2">
                      {page.topQueries.map((q, i) => (
                        <div key={i} className="flex items-center justify-between p-3 rounded-lg border border-slate-100 bg-white hover:border-blue-200 transition-all group">
                          <div className="flex items-center gap-3 overflow-hidden"><Search className="w-3.5 h-3.5 text-slate-400 group-hover:text-blue-500 transition-colors shrink-0" /><span className="text-sm text-slate-700 font-medium truncate">{q.query}</span></div>
                          <div className="text-xs text-slate-400 font-mono shrink-0 pl-2">#{q.position.toFixed(0)}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
              <div className="p-6 border-t border-slate-100 bg-slate-50/50 backdrop-blur">
                 <a href={page.url} target="_blank" rel="noreferrer" className="flex items-center justify-center gap-2 w-full py-3 px-4 bg-white border border-slate-200 hover:border-blue-300 hover:text-blue-600 rounded-xl text-sm font-medium text-slate-600 transition-all shadow-sm hover:shadow-md"><span>Open live page</span><ExternalLink className="w-3.5 h-3.5" /></a>
              </div>
            </div>
          </div>
        );
      };

      // ==========================================
      // 4. MAIN APP LOGIC
      // ==========================================
      
      function App() {
        const [step, setStep] = useState('landing');
        const [user, setUser] = useState(null);
        const [properties, setProperties] = useState([]);
        const [selectedProperty, setSelectedProperty] = useState(null);
        const [sitemapUrl, setSitemapUrl] = useState('');
        const [results, setResults] = useState([]);
        const [loading, setLoading] = useState(false);
        const [selectedPage, setSelectedPage] = useState(null);
        const [loadingMessage, setLoadingMessage] = useState('');
        const [backendStatus, setBackendStatus] = useState('checking');
        const api = new ApiService();

        useEffect(() => {
          const init = async () => {
             // Check URL for errors
             const params = new URLSearchParams(window.location.search);
             if (params.get('error')) {
               console.error("Auth Error:", params.get('error'));
               alert("Authentication Failed: " + params.get('error'));
               window.history.replaceState({}, document.title, window.location.pathname);
             }

             // Check backend connection
             try {
               setLoading(true);
               setLoadingMessage("Connecting to backend...");
               const user = await api.getMe();
               if (user) {
                 setUser(user);
                 setBackendStatus('connected');
                 // Try fetching properties
                 try {
                   const props = await api.getProperties();
                   setProperties(props);
                 } catch(e) {
                   console.warn("Could not fetch properties (maybe mock mode needed)", e);
                   setProperties(MOCK_PROPERTIES);
                 }
                 setStep('properties');
               } else {
                 setBackendStatus('disconnected');
               }
             } catch (e) {
               if (e.message === "BACKEND_MISSING") {
                  setBackendStatus('error');
                  alert("CRITICAL UPLOAD ERROR: The backend functions are missing.\n\nThe server returned HTML for the API endpoint. This means Cloudflare cannot find your 'functions' folder.\n\nACTION REQUIRED:\nWhen uploading to Cloudflare Pages, you must ensure the 'functions' folder is at the top level of your zip file, not inside another folder like 'Gsc seo'.");
               } else {
                  console.error("Backend unreachable", e);
                  setBackendStatus('error');
               }
             } finally {
               setLoading(false);
             }
          };
          init();
        }, []);

        const handleConnect = async () => {
          setLoading(true);
          setLoadingMessage("Checking system status...");
          
          try {
             const res = await fetch('/auth/debug');
             const contentType = res.headers.get("content-type");
             if (contentType && contentType.includes("text/html")) {
                alert("SYSTEM ERROR: Backend functions not found.\n\nPlease re-upload your project ensuring the 'functions' folder is at the root.");
                setLoading(false);
                return;
             }
          } catch(e) { console.warn(e); }

          setLoadingMessage("Redirecting to Google...");
          window.location.href = `${window.location.origin}/auth/login`;
        };
        
        const handleUseDemo = async () => {
          setLoading(true);
          setLoadingMessage("Loading demo data...");
          const data = await mockAuth();
          setUser(data.user);
          setProperties(data.properties);
          setStep('properties');
          setLoading(false);
        }

        const handleLogout = async () => {
          await api.logout();
          setUser(null);
          setStep('landing');
          setProperties([]);
          setResults([]);
        };

        const handleSelectProperty = (prop) => {
          setSelectedProperty(prop);
          setSitemapUrl(`${prop.siteUrl}/sitemap.xml`);
          setStep('sitemap');
        };

        const handleAnalyze = async (e) => {
          e.preventDefault();
          setStep('analyzing');
          setLoading(true);
          try {
            setLoadingMessage('Fetching real data from Google...');
            // NEW: Call the real backend API
            const rawData = await api.analyzeSite(selectedProperty.siteUrl, sitemapUrl);
            
            setLoadingMessage('Generating insights...');
            // Process the raw data through the insight engine
            const analyzedData = rawData.map((page, index) => {
                const insight = generateInsight(page);
                return { id: `page-${index}`, ...page, ...insight };
            });

            setResults(analyzedData);
            setStep('results');
          } catch (err) {
            console.error(err);
            alert('Failed to analyze: ' + err.message);
            setStep('sitemap');
          } finally {
            setLoading(false);
            setLoadingMessage('');
          }
        };

        const getStatusBadge = (classification) => {
          let styles = "bg-slate-100 text-slate-700 ring-slate-500/20";
          if (classification === 'Indexed & Visible') styles = "bg-green-50 text-green-700 ring-green-600/20";
          else if (classification === 'Indexed but Ignored') styles = "bg-yellow-50 text-yellow-700 ring-yellow-600/20";
          else if (classification === 'Not Indexed') styles = "bg-red-50 text-red-700 ring-red-600/20";
          return <span className={`inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium ring-1 ring-inset ${styles}`}>{classification}</span>;
        };

        if (loading && !step) {
          return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Sparkles className="w-8 h-8 text-blue-600 animate-spin" /></div>;
        }

        return (
          <Layout user={user} onLogout={handleLogout}>
            {step === 'landing' && (
              <div className="relative flex flex-col items-center justify-center text-center max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-8 duration-700">
                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 border border-blue-100 text-blue-700 text-xs font-semibold uppercase tracking-wide mb-8">
                  <span className="relative flex h-2 w-2">
                    <span className={`animate-ping absolute inline-flex h-full w-full rounded-full ${backendStatus !== 'error' ? 'bg-green-400' : 'bg-red-400'} opacity-75`}></span>
                    <span className={`relative inline-flex rounded-full h-2 w-2 ${backendStatus !== 'error' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                  </span>
                  {backendStatus !== 'error' ? 'System Operational' : 'Backend Disconnected'}
                </div>
                <h1 className="text-5xl sm:text-7xl font-extrabold text-slate-900 tracking-tight mb-8 leading-[1.1]">How Google <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">really</span><br className="hidden sm:block"/> sees your website.</h1>
                <p className="text-lg sm:text-xl text-slate-600 mb-12 max-w-2xl leading-relaxed">Stop guessing with SEO tools. Connect Search Console to see exactly which pages are indexed, invisible, or ignored—explained in plain English.</p>
                <div className="flex flex-col sm:flex-row items-center gap-4 w-full max-w-md justify-center">
                  <Button size="lg" onClick={handleConnect} isLoading={loading} className="w-full sm:w-auto shadow-xl shadow-blue-500/20"><ShieldCheck className="w-5 h-5 mr-2" /> Login with Google</Button>
                  <Button size="lg" variant="secondary" onClick={handleUseDemo} className="w-full sm:w-auto">Try Demo Data</Button>
                </div>
                <div className="mt-24 grid grid-cols-2 sm:grid-cols-4 gap-8 w-full border-t border-slate-200 pt-12">
                  {[{ label: "Real Data", sub: "Direct from Google" }, { label: "No Scraping", sub: "100% compliant" }, { label: "Plain English", sub: "No jargon" }, { label: "Actionable", sub: "Clear next steps" }].map((item, i) => (
                    <div key={i} className="flex flex-col items-center"><span className="font-bold text-slate-900 text-lg">{item.label}</span><span className="text-sm text-slate-500">{item.sub}</span></div>
                  ))}
                </div>
              </div>
            )}

            {/* Other steps (properties, sitemap, results) remain unchanged */}
            {step === 'properties' && (
              <div className="max-w-3xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
                <h2 className="text-3xl font-bold text-slate-900 mb-2 text-center">Select a Property</h2>
                <p className="text-slate-500 text-center mb-10">Choose a site to analyze from your Search Console account.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {properties.map((prop) => (
                    <button key={prop.siteUrl} onClick={() => handleSelectProperty(prop)} className="group relative flex flex-col items-start p-6 bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-lg hover:border-blue-300 transition-all duration-300 text-left">
                      <div className="absolute top-6 right-6 opacity-0 group-hover:opacity-100 transition-opacity transform group-hover:translate-x-1"><ArrowRight className="w-5 h-5 text-blue-500" /></div>
                      <div className="bg-blue-50 p-3 rounded-xl mb-4 group-hover:bg-blue-600 transition-colors"><Globe className="w-6 h-6 text-blue-600 group-hover:text-white transition-colors" /></div>
                      <h3 className="font-bold text-slate-900 truncate w-full mb-1">{prop.siteUrl.replace(/^https?:\/\//, '')}</h3>
                      <p className="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-1 rounded">{prop.permissionLevel === 'siteOwner' ? 'Owner' : 'Full User'}</p>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {step === 'sitemap' && (
              <div className="max-w-xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
                <button onClick={() => setStep('properties')} className="mb-8 text-sm text-slate-400 hover:text-slate-600 flex items-center gap-1">← Back to properties</button>
                <div className="text-center mb-10">
                   <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-50 text-indigo-600 mb-6"><Search className="w-8 h-8" /></div>
                  <h2 className="text-3xl font-bold text-slate-900 mb-3">Locate your Sitemap</h2>
                  <p className="text-slate-500 text-lg">We'll fetch all your pages to cross-reference with Google's index.</p>
                </div>
                <form onSubmit={handleAnalyze} className="bg-white p-2 rounded-2xl border border-slate-200 shadow-xl shadow-slate-200/50 flex flex-col sm:flex-row gap-2">
                  <input type="url" required value={sitemapUrl} onChange={(e) => setSitemapUrl(e.target.value)} className="flex-1 px-6 py-4 rounded-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:bg-slate-50 transition-colors text-base" placeholder="https://example.com/sitemap.xml" />
                  <Button type="submit" size="lg" className="rounded-xl shrink-0">Start Analysis</Button>
                </form>
              </div>
            )}

            {step === 'analyzing' && (
              <div className="flex flex-col items-center justify-center py-20 animate-in fade-in duration-700">
                <div className="relative w-24 h-24 mb-8">
                  <div className="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                  <div className="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
                </div>
                <h3 className="text-2xl font-bold text-slate-900 mb-2 animate-pulse">{loadingMessage}</h3>
                <p className="text-slate-500">Connecting to Google Search Console API...</p>
              </div>
            )}

            {step === 'results' && (
              <div className="animate-in fade-in slide-in-from-bottom-8 duration-700">
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4">
                  <div>
                    <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-3">Analysis Report <span className="px-2.5 py-1 rounded-full bg-slate-100 text-slate-600 text-xs font-medium border border-slate-200">{results.length} Pages</span></h2>
                    <p className="text-slate-500 mt-1">Data source: <span className="font-medium text-slate-900">{selectedProperty?.siteUrl}</span></p>
                  </div>
                  <Button variant="secondary" size="sm" onClick={() => setStep('sitemap')}>New Analysis</Button>
                </div>
                <div className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
                  <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm whitespace-nowrap">
                      <thead className="bg-slate-50/80 border-b border-slate-200 text-slate-500 font-semibold">
                        <tr><th className="px-6 py-4 w-1/3">Page URL</th><th className="px-6 py-4">Visibility Status</th><th className="px-6 py-4 text-right">Impressions</th><th className="px-6 py-4 text-right">Avg Pos</th><th className="px-6 py-4 text-right w-20"></th></tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {results.map((page) => (
                          <tr key={page.id} onClick={() => setSelectedPage(page)} className="hover:bg-blue-50/50 transition-colors cursor-pointer group">
                            <td className="px-6 py-4"><div className="font-medium text-slate-900 truncate max-w-[200px] sm:max-w-xs" title={page.url}>{page.url.replace(selectedProperty?.siteUrl || '', '') || '/'}</div></td>
                            <td className="px-6 py-4">{getStatusBadge(page.classification)}</td>
                            <td className="px-6 py-4 text-right font-mono text-slate-600">{page.impressions.toLocaleString()}</td>
                            <td className="px-6 py-4 text-right font-mono text-slate-600">{page.position > 0 ? page.position.toFixed(1) : <span className="text-slate-300">-</span>}</td>
                            <td className="px-6 py-4 text-right"><ChevronRight className="w-5 h-5 text-slate-300 group-hover:text-blue-500 transition-colors" /></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
            <DetailDrawer isOpen={!!selectedPage} page={selectedPage} onClose={() => setSelectedPage(null)} />
          </Layout>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>